# Активный контекст

Текущий активный контекст проекта является начальным и будет обновляться по мере работы с проектом.

## Основная информация

GPROD Backend - это бэкенд API приложение, построенное на NestJS с использованием TypeScript, Prisma ORM и PostgreSQL. Проект находится в активной разработке, с полностью реализованным API v1 и частично реализованным API v2.

## Текущий фокус

В данный момент выполняется начальная настройка и анализ проекта для понимания его структуры и архитектуры.

## Ключевые модули

- **Аутентификация и авторизация** - JWT с refresh токенами и ролевая модель
- **Управление пользователями** - создание, редактирование, удаление пользователей
- **Управление проектами** - работа с проектами, связанными с пользователями

## Приоритетные задачи

- Завершение изучения структуры проекта
- Определение стратегии для дальнейшей разработки
- Планирование улучшений и расширений функциональности

## Обновленная информация о проекте

### Структура исходного кода

#### Основные директории
- src/ - основной исходный код приложения
  - common/ - общие компоненты, утилиты и настройки
  - modules/ - модули приложения (auth, users, projects, health)
  - app.module.ts - корневой модуль приложения
  - main.ts - точка входа в приложение

#### Модули приложения
- auth/ - аутентификация и авторизация
- users/ - управление пользователями
- projects/ - управление проектами
- health/ - проверка состояния приложения

### Схема базы данных (Prisma)

#### Основные модели
- User - пользователи с ролями
  - id, username, email, password, isActive, roles, etc.
- Project - проекты, связанные с пользователями
  - id, title, description, ownerId, etc.
- RefreshToken - токены обновления для системы аутентификации
  - id, token, userId, expiresAt, etc.

### Система безопасности

#### Аутентификация
- JWT токены для аутентификации
- Refresh токены для обновления доступа
- Стратегии Passport.js для авторизации

#### Авторизация
- Ролевая модель безопасности (RBAC)
- RolesGuard для защиты эндпоинтов на основе ролей
- Декоратор @Roles для определения необходимых ролей

## Анализ API эндпоинтов

### Модуль управления пользователями
- POST /users - Создание пользователя (публичный доступ)
- GET /users - Получение списка пользователей (требует JWT, поддерживает пагинацию, поиск, сортировку)
- GET /users/:id - Получение пользователя по ID (требует JWT)
- PATCH /users/:id - Обновление пользователя (требует JWT, только admin может назначать роли)
- DELETE /users/:id - Удаление пользователя (требует JWT, требуется роль admin)

### Модуль управления проектами
- POST /projects - Создание проекта (требует JWT, ограничение: 10 запросов в минуту)
- GET /projects - Получение списка проектов (требует JWT, поддерживает пагинацию, поиск, сортировку, ограничение: 30 запросов в минуту)
- GET /projects/:id - Получение проекта по ID (требует JWT)
- PATCH /projects/:id - Обновление проекта (требует JWT)
- DELETE /projects/:id - Удаление проекта (требует JWT, только admin или владелец проекта)

### Особенности API
- Широкое использование Swagger для документации API
- Детальное описание ответов и ошибок
- Защита эндпоинтов с использованием JWT и ролевой модели
- Ограничение частоты запросов для некоторых эндпоинтов
- Фильтрация, пагинация и сортировка для списков

## Инфраструктура и DevOps

На основе анализа файлов в директориях INFRA и .memory/devops было выявлено:

1. **Развертывание в K3S кластере**
   - Кластер расположен на сервере infra.gyber.org с внешним IP 31.129.105.180
   - Для проекта создан namespace develop-gprod
   - Настроены URL: dev.gprod.build.infra.gyber.org, api.dev.gprod.build.infra.gyber.org

2. **CI/CD с GitHub Actions**
   - Полный pipeline с линтингом, тестами, сборкой и деплоем
   - Автоматические миграции базы данных
   - Проверки работоспособности и автоматический откат при ошибках
   - Уведомления в Telegram

3. **Helm для управления деплоем**
   - Шаблонизация Kubernetes манифестов
   - Управление версиями и откат релизов
   - Настройка через values файлы

4. **Текущие проблемы**
   - ESLint-ошибки с типизацией в тестах
   - Отсутствие разделения на dev/stage/prod окружения

Вся документация по инфраструктуре и DevOps доступна в memory-bank/devops/.

## Автоматизация разработки и деплоя

Проект имеет развитую систему автоматизации для разработки, тестирования и деплоя:

### Управление окружениями

- Поддержка трех контуров: **dev**, **stage** и **prod**
- Скрипты для автоматического переключения между контурами
- Автоматическая настройка переменных окружения
- Интерактивный режим запуска и настройки

### Docker и контейнеризация

- Docker Compose конфигурации для каждого контура
- Автоматическая сборка и перезапуск контейнеров
- Изолированные базы данных для разных окружений

### Тестирование

- Автоматизированный запуск тестов через скрипты
- Поддержка запуска тестов в Docker-контейнерах
- Умное определение и запуск различных типов тестов

### Инструменты для K3S

- Скрипты для установки Helm
- Инструменты для сбора информации о кластере
- Поддержка интеграции с Kubernetes

Вся документация по автоматизации доступна в memory-bank/devops/automation/.

## Helm-чарт и миграции базы данных

Проект использует Helm для деплоя и Prisma для управления схемой базы данных:

1. **Helm-чарт** обеспечивает деплой приложения в Kubernetes:
   - Настройка через values.yaml и values-dev.yaml
   - Определение ресурсов: Deployment, Service, Ingress, Secret
   - Интеграция с cert-manager для TLS

2. **Миграции Prisma** управляют схемой базы данных:
   - Отслеживание истории миграций: init, add_refresh_token, add_roles_column
   - Различные команды для применения миграций в разных окружениях
   - Автоматизация миграций через CI/CD

Вся документация по Helm и миграциям доступна в директории memory-bank/devops/.

## API и тестирование

Проведен детальный анализ API эндпоинтов и системы тестирования:

### API эндпоинты

- **Модули API:**
  - auth: регистрация, авторизация, обновление токенов
  - users: управление пользователями
  - projects: управление проектами
  - health: проверка работоспособности

- **Безопасность:**
  - JWT аутентификация с refresh токенами
  - Ролевая модель (RBAC)
  - Rate Limiting для защиты от атак
  - Валидация входных данных

### Система тестирования

- **Unit-тесты** для отдельных компонентов
- **E2E-тесты** для интеграционного тестирования API
- **Тестовые сценарии** для различных аспектов API:
  - аутентификация и авторизация
  - управление пользователями и проектами
  - проверка безопасности и ограничений
  - валидация и обработка ошибок

Вся документация доступна в директории memory-bank/api/.

## План реализации приоритетных улучшений API

### Фаза 1: Улучшение работы с токенами

Необходимо реализовать:
1. Хранение активных refresh токенов в базе данных (таблица RefreshToken уже существует)
2. Механизм отзыва токенов при логауте или смене пароля
3. Эндпоинт для logout

#### Технические шаги:
1. Обновить AuthService для сохранения refresh токена в БД при логине
2. Добавить проверку refresh токена в методе refresh
3. Создать эндпоинт logout для отзыва токена
4. Реализовать автоматический отзыв токенов при смене пароля

### Фаза 2: Усиленный Rate Limiting

Необходимо реализовать:
1. Настраиваемые лимиты для разных типов запросов
2. Прогрессивное ограничение при повторяющихся атаках
3. Интеграцию с системой логирования

#### Технические шаги:
1. Расширить декоратор RateLimit для поддержки разных типов запросов
2. Создать хранилище для счетчиков запросов с прогрессивным увеличением времени блокировки
3. Интегрировать логирование для отслеживания потенциальных атак

### Фаза 3: Оптимизация запросов Prisma

Необходимо реализовать:
1. Оптимизацию селекторов полей в запросах
2. Улучшение запросов с JOIN
3. Внедрение курсорной пагинации

#### Технические шаги:
1. Проанализировать текущие запросы и оптимизировать выборку полей
2. Улучшить запросы с включением связанных данных
3. Реализовать курсорную пагинацию для списочных эндпоинтов
