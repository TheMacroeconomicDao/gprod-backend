# Активный контекст

Текущий активный контекст проекта является начальным и будет обновляться по мере работы с проектом.

## Основная информация

GPROD Backend - это бэкенд API приложение, построенное на NestJS с использованием TypeScript, Prisma ORM и PostgreSQL. Проект находится в активной разработке, с полностью реализованным API v1 и частично реализованным API v2.

## Текущий фокус

В данный момент выполняется начальная настройка и анализ проекта для понимания его структуры и архитектуры.

## Ключевые модули

- **Аутентификация и авторизация** - JWT с refresh токенами и ролевая модель
- **Управление пользователями** - создание, редактирование, удаление пользователей
- **Управление проектами** - работа с проектами, связанными с пользователями

## Приоритетные задачи

- Завершение изучения структуры проекта
- Определение стратегии для дальнейшей разработки
- Планирование улучшений и расширений функциональности

## Обновленная информация о проекте

### Структура исходного кода

#### Основные директории
- src/ - основной исходный код приложения
  - common/ - общие компоненты, утилиты и настройки
  - modules/ - модули приложения (auth, users, projects, health)
  - app.module.ts - корневой модуль приложения
  - main.ts - точка входа в приложение

#### Модули приложения
- auth/ - аутентификация и авторизация
- users/ - управление пользователями
- projects/ - управление проектами
- health/ - проверка состояния приложения

### Схема базы данных (Prisma)

#### Основные модели
- User - пользователи с ролями
  - id, username, email, password, isActive, roles, etc.
- Project - проекты, связанные с пользователями
  - id, title, description, ownerId, etc.
- RefreshToken - токены обновления для системы аутентификации
  - id, token, userId, expiresAt, etc.

### Система безопасности

#### Аутентификация
- JWT токены для аутентификации
- Refresh токены для обновления доступа
- Стратегии Passport.js для авторизации

#### Авторизация
- Ролевая модель безопасности (RBAC)
- RolesGuard для защиты эндпоинтов на основе ролей
- Декоратор @Roles для определения необходимых ролей

## Анализ API эндпоинтов

### Модуль управления пользователями
- POST /users - Создание пользователя (публичный доступ)
- GET /users - Получение списка пользователей (требует JWT, поддерживает пагинацию, поиск, сортировку)
- GET /users/:id - Получение пользователя по ID (требует JWT)
- PATCH /users/:id - Обновление пользователя (требует JWT, только admin может назначать роли)
- DELETE /users/:id - Удаление пользователя (требует JWT, требуется роль admin)

### Модуль управления проектами
- POST /projects - Создание проекта (требует JWT, ограничение: 10 запросов в минуту)
- GET /projects - Получение списка проектов (требует JWT, поддерживает пагинацию, поиск, сортировку, ограничение: 30 запросов в минуту)
- GET /projects/:id - Получение проекта по ID (требует JWT)
- PATCH /projects/:id - Обновление проекта (требует JWT)
- DELETE /projects/:id - Удаление проекта (требует JWT, только admin или владелец проекта)

### Особенности API
- Широкое использование Swagger для документации API
- Детальное описание ответов и ошибок
- Защита эндпоинтов с использованием JWT и ролевой модели
- Ограничение частоты запросов для некоторых эндпоинтов
- Фильтрация, пагинация и сортировка для списков

## Инфраструктура и DevOps

На основе анализа файлов в директориях INFRA и .memory/devops было выявлено:

1. **Развертывание в K3S кластере**
   - Кластер расположен на сервере infra.gyber.org с внешним IP 31.129.105.180
   - Для проекта создан namespace develop-gprod
   - Настроены URL: dev.gprod.build.infra.gyber.org, api.dev.gprod.build.infra.gyber.org

2. **CI/CD с GitHub Actions**
   - Полный pipeline с линтингом, тестами, сборкой и деплоем
   - Автоматические миграции базы данных
   - Проверки работоспособности и автоматический откат при ошибках
   - Уведомления в Telegram

3. **Helm для управления деплоем**
   - Шаблонизация Kubernetes манифестов
   - Управление версиями и откат релизов
   - Настройка через values файлы

4. **Текущие проблемы**
   - ESLint-ошибки с типизацией в тестах
   - Отсутствие разделения на dev/stage/prod окружения

Вся документация по инфраструктуре и DevOps доступна в memory-bank/devops/.

## Автоматизация разработки и деплоя

Проект имеет развитую систему автоматизации для разработки, тестирования и деплоя:

### Управление окружениями

- Поддержка трех контуров: **dev**, **stage** и **prod**
- Скрипты для автоматического переключения между контурами
- Автоматическая настройка переменных окружения
- Интерактивный режим запуска и настройки

### Docker и контейнеризация

- Docker Compose конфигурации для каждого контура
- Автоматическая сборка и перезапуск контейнеров
- Изолированные базы данных для разных окружений

### Тестирование

- Автоматизированный запуск тестов через скрипты
- Поддержка запуска тестов в Docker-контейнерах
- Умное определение и запуск различных типов тестов

### Инструменты для K3S

- Скрипты для установки Helm
- Инструменты для сбора информации о кластере
- Поддержка интеграции с Kubernetes

Вся документация по автоматизации доступна в memory-bank/devops/automation/.
