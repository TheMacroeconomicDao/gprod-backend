# Задачи

## Текущие задачи

### Задача: Инициализация Memory Bank

#### Описание
Настройка Memory Bank системы для проекта GPROD Backend для обеспечения эффективной работы с проектом.

#### Чеклист
- [x] Создание директории memory-bank
- [x] Создание основных файлов Memory Bank
- [x] Заполнение projectbrief.md основной информацией о проекте
- [x] Заполнение techContext.md технической информацией
- [x] Заполнение systemPatterns.md информацией о паттернах системы
- [x] Заполнение productContext.md информацией о продукте
- [x] Заполнение activeContext.md информацией о текущем контексте
- [x] Заполнение progress.md информацией о прогрессе
- [x] Заполнение style-guide.md руководством по стилю

#### Следующие шаги
- [ ] Проанализировать структуру проекта более детально
- [ ] Изучить схему базы данных (Prisma)
- [ ] Разобрать систему аутентификации и авторизации

## Планируемые задачи


Read file: memory-bank/tasks.md
Добавь в раздел "Планируемые задачи" файла `memory-bank/tasks.md`:

---

### Задача: Миграция на run-new и удаление run.sh

#### Описание
В проекте подготовлена новая модульная система автоматизации (`run-new.sh` + библиотеки в `lib/`), которая покрывает все основные сценарии управления окружением, билдом, тестами, логами, пересборкой, интерактивным режимом и CI/CD.  
Проведён анализ: run-new покрывает 99% edge cases старого run.sh, кроме ultra-локальных e2e вне Docker (run-tests.sh). Для production, CI/CD и командной работы через Docker — run-new полностью готов к замене run.sh.

#### Чеклист
- [ ] Проверить, что все npm/pnpm-скрипты и CI/CD используют run-new.sh как основной entrypoint
- [ ] Интегрировать run-tests.sh в run-new для ultra-локальных e2e (если нужно)
- [ ] Провести smoke-тесты всех сценариев (dev, stage, prod, reference, интерактив, тесты, пересборка, удаление томов)
- [ ] Обновить документацию и onboarding
- [ ] Удалить legacy run.sh из репозитория после успешной миграции

#### Примечание
**MS (milestone):** Всё готово для полного перехода на run-new.  
Удаление run.sh возможно после финального smoke-тестирования и обновления всех workflow.





### Задача: Детальный анализ проекта

#### Описание
Проведен детальный анализ исходного кода проекта, схемы базы данных и системы аутентификации/авторизации.

#### Чеклист
- [x] Анализ структуры модулей
  - Идентифицированы модули: auth, users, projects, health
- [x] Обзор Prisma схемы
  - Изучены модели: User, Project, RefreshToken
- [x] Анализ системы безопасности
  - Проанализирована JWT-аутентификация
  - Изучена ролевая модель (RBAC)
- [x] Обновление документации Memory Bank
  - Обновлены файлы activeContext.md и progress.md

#### Следующие шаги
- [ ] Детальный анализ API эндпоинтов и их реализации
- [ ] Изучение процесса миграции базы данных
- [ ] Анализ конфигурации и переменных окружения

---

### Задача: Улучшение системы безопасности

#### Описание
Разработка рекомендаций по улучшению системы безопасности приложения.

#### Чеклист
- [ ] Анализ текущих мер безопасности
- [ ] Выявление потенциальных уязвимостей
- [ ] Разработка рекомендаций по улучшению
- [ ] Документирование предложенных улучшений

### Задача: Анализ инфраструктуры и DevOps

#### Описание
Проведен анализ файлов в директориях INFRA и .memory/devops для понимания инфраструктуры и DevOps процессов проекта.

#### Чеклист
- [x] Анализ структуры кластера K3S
  - Изучена информация о хостинге, версиях и ресурсах
  - Проанализированы компоненты кластера (Ingress, Storage, DNS и др.)
- [x] Анализ CI/CD pipeline
  - Изучены этапы CI/CD в GitHub Actions
  - Выявлены проблемы с ESLint-ошибками
- [x] Изучение процесса деплоя
  - Проанализированы инструкции по деплою в K3S
  - Изучен подход к управлению секретами
- [x] Документирование инфраструктуры и DevOps
  - Создан файл memory-bank/devops/infrastructure.md
  - Создан файл memory-bank/devops/k8s-helm-cheatsheet.md
  - Обновлены activeContext.md и progress.md

#### Следующие шаги
- [ ] Детальный анализ CI/CD в GitHub Actions
- [ ] Изучение Helm-чарта для деплоя
- [ ] Документирование процесса миграции базы данных

---

### Задача: Разработка стратегии разделения окружений

#### Описание
Необходимо разработать стратегию разделения на dev/stage/prod окружения для проекта GProd Backend.

#### Чеклист
- [ ] Анализ текущей конфигурации окружений
- [ ] Разработка структуры Helm values для разных окружений
- [ ] Определение различий в конфигурации для dev/stage/prod
- [ ] Планирование CI/CD pipeline для разных окружений
- [ ] Документирование процесса деплоя в разные окружения

### Задача: Анализ системы автоматизации

#### Описание
Проведен анализ скриптов автоматизации в директории `automation/` для понимания процессов разработки, тестирования и деплоя.

#### Чеклист
- [x] Анализ структуры директории automation/
  - Изучены основные компоненты: env/, k3s/, scripts/
  - Проанализирован главный скрипт run.sh
- [x] Анализ системы управления окружениями
  - Изучены скрипты env-manager.sh, env-switch-new.sh
  - Проанализирована работа с контурами dev/stage/prod
- [x] Анализ интеграции с K3S
  - Изучены скрипты get_helm.sh, collect_master.sh
  - Понимание интеграции с Kubernetes
- [x] Документирование системы автоматизации
  - Создан файл memory-bank/devops/automation/overview.md
  - Создан файл memory-bank/devops/automation/environment-management.md
  - Обновлены activeContext.md и progress.md

#### Следующие шаги
- [ ] Детальный анализ скриптов управления тестами
- [ ] Документирование процесса запуска и отладки приложения
- [ ] Интеграция с CI/CD

---

### Задача: Улучшение системы автоматизации

#### Описание
Разработка предложений по улучшению существующей системы автоматизации для повышения эффективности процессов разработки и деплоя.

#### Чеклист
- [ ] Анализ текущих ограничений и проблем
- [ ] Разработка предложений по улучшению скриптов
- [ ] Интеграция с системой CI/CD
- [ ] Улучшение процесса управления окружениями
- [ ] Документирование предложенных улучшений

### Задача: Анализ Helm-чарта и миграций

#### Описание
Проведен анализ Helm-чарта для деплоя приложения и миграций базы данных через Prisma.

#### Чеклист
- [x] Анализ структуры Helm-чарта
  - Изучены основные компоненты: Deployment, Service, Ingress, Secret
  - Проанализированы values.yaml и values-dev.yaml
- [x] Анализ миграций базы данных
  - Изучены три миграции: init, add_refresh_token, add_roles_column
  - Проанализирован процесс применения миграций
- [x] Документирование Helm и миграций
  - Создан файл memory-bank/devops/helm-chart.md
  - Создан файл memory-bank/devops/migrations/database-migrations.md
  - Обновлены activeContext.md и progress.md

#### Следующие шаги
- [ ] Анализ CI/CD пайплайна для деплоя с миграциями
- [ ] Разработка предложений по улучшению процесса миграций

---

### Задача: Анализ API эндпоинтов

#### Описание
Необходимо провести детальный анализ API эндпоинтов и их реализации в исходном коде.

#### Чеклист
- [ ] Изучение контроллеров и их методов
- [ ] Анализ DTO объектов и валидации
- [ ] Исследование сервисного слоя
- [ ] Анализ документации Swagger
- [ ] Создание полной карты API эндпоинтов

### Задача: Анализ API эндпоинтов

#### Описание
Проведен детальный анализ API эндпоинтов, их реализации, DTO объектов и системы безопасности.

#### Чеклист
- [x] Изучение контроллеров и их методов
  - Проанализированы все контроллеры: auth, users, projects, health
  - Изучены методы и их параметры
- [x] Анализ DTO объектов и валидации
  - Исследованы CreateUserDto, UpdateUserDto
  - Исследованы CreateProjectDto, UpdateProjectDto
  - Проанализированы валидационные правила
- [x] Исследование сервисного слоя
  - Изучена логика работы сервисов
  - Проанализирована бизнес-логика
- [x] Анализ безопасности API
  - Изучены механизмы JWT аутентификации
  - Проанализирована ролевая модель (RBAC)
  - Исследован механизм Rate Limiting
- [x] Анализ системы тестирования
  - Изучены unit и e2e тесты
  - Проанализированы скрипты запуска тестов
  - Исследована интеграция с CI/CD
- [x] Документирование API
  - Создан файл memory-bank/api/endpoints.md
  - Создан файл memory-bank/api/security.md
  - Создан файл memory-bank/api/testing.md

#### Следующие шаги
- [ ] Разработка предложений по улучшению API
- [ ] Анализ производительности API
- [ ] Разработка стратегии для API v2

---

### Задача: Разработка предложений по улучшению API

#### Описание
Необходимо разработать предложения по улучшению существующего API, его расширению и оптимизации.

#### Чеклист
- [ ] Анализ текущих ограничений API
- [ ] Разработка предложений по улучшению безопасности
- [ ] Разработка предложений по расширению функциональности
- [ ] Разработка предложений по оптимизации производительности
- [ ] Создание документа с рекомендациями

### Задача: Реализация приоритетных улучшений API

#### Описание
Необходимо реализовать три приоритетных улучшения API, выявленных в ходе анализа: улучшение работы с токенами, усиленный Rate Limiting и оптимизацию запросов Prisma.

#### Чеклист
- [x] Улучшение работы с токенами
  - [x] Создание хранилища активных токенов
  - [x] Реализация механизма отзыва токенов
  - [x] Добавление эндпоинта для logout
- [x] Усиленный Rate Limiting
  - [x] Реализация настраиваемых лимитов для разных типов запросов
  - [x] Добавление прогрессивного ограничения при повторяющихся атаках
  - [x] Интеграция с системой логирования
- [ ] Оптимизация запросов Prisma
  - [ ] Оптимизация селекторов полей
  - [ ] Улучшение запросов с JOIN
  - [ ] Внедрение курсорной пагинации

#### Прогресс
- [x] Фаза 1: Улучшение работы с токенами
- [x] Фаза 2: Усиленный Rate Limiting
- [ ] Фаза 3: Оптимизация запросов Prisma

### Задача: Рефакторинг CI/CD пайплайна

#### Описание
Вынести healthcheck в централизованный скрипт, устранить дублирование, улучшить диагностику и стабильность пайплайна.

#### Чеклист
- [x] Вынести healthcheck в bash-скрипт (automation/scripts/healthcheck.sh)
- [x] Использовать один и тот же скрипт во всех workflow-джобах (DRY)
- [x] Добавить retry, проверку кода ответа, подробный вывод
- [x] В Telegram-алертах выводить полный ответ healthcheck
- [x] Сделать миграции фейлящимися при ошибке
- [x] Rollback на предыдущий релиз, а не всегда на первый
- [x] В алерте rollback указывать номер релиза
- [x] Добавить таймауты на rollout и миграции
- [x] Pin версий action-setup для Helm, Docker, PNPM
- [x] Добавить Helm dry-run перед деплоем
- [x] Вынести ключевые переменные в начало deploy.yml
- [x] Проверять наличие jq/curl в healthcheck

#### Результат
Пайплайн стал надёжнее, прозрачнее, поддерживаемее. Ложные алерты устранены, диагностика проще.
