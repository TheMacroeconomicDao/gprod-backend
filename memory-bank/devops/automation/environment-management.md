# Руководство по управлению окружениями

## Введение

Проект GPROD использует гибкую систему управления окружениями через набор скриптов в директории `automation/env/`. Эти скрипты позволяют легко переключаться между контурами разработки, тестирования и продакшена.

## Основные скрипты

### env-manager.sh

Главный скрипт для настройки и переключения между контурами окружения.

**Использование:**
```bash
./automation/env/env-manager.sh <контур> [--silent] [--docker|--local]
```

**Параметры:**
- `<контур>` - название контура (dev, stage, prod)
- `--silent` - тихий режим без запросов
- `--docker` - запустить Docker контейнеры для выбранного контура
- `--local` - настроить только локальное окружение без запуска Docker

**Примеры:**
```bash
# Настройка dev-окружения с интерактивным запросом на запуск Docker
./automation/env/env-manager.sh dev

# Настройка prod-окружения без запросов и запуск Docker
./automation/env/env-manager.sh prod --silent --docker

# Настройка stage-окружения без запуска Docker
./automation/env/env-manager.sh stage --local
```

### env-switch-new.sh

Расширенная версия скрипта переключения окружений с дополнительными возможностями.

**Использование:**
```bash
./automation/env/env-switch-new.sh [контур] [--silent]
```

### setup-env-files.sh

Скрипт для первоначальной настройки файлов окружения из шаблонов или с нуля.

**Использование:**
```bash
./automation/env/setup-env-files.sh [--force]
```

## Контуры окружения

### Development (dev)

- **Файл окружения:** `.env.development`
- **Docker Compose:** `docker-compose.dev.yml`
- **Порт API:** 3008
- **Порт БД:** 5432
- **Особенности:** автоматические миграции, hot-reload

### Staging (stage)

- **Файл окружения:** `.env.staging`
- **Docker Compose:** `docker-compose.stage.yml`
- **Порт API:** 3003
- **Порт БД:** 5433
- **Особенности:** мониторинг Prometheus + Grafana

### Production (prod)

- **Файл окружения:** `.env.production`
- **Docker Compose:** `docker-compose.prod.yml`
- **Порт API:** 3007
- **Порт БД:** 5434
- **Особенности:** nginx с SSL, промышленный мониторинг

## Работа с переменными окружения

Скрипты автоматически создают символическую ссылку `.env -> .env.<контур>` для переключения между контурами. Структура файлов окружения:

```
.env                 # Символическая ссылка на активный файл окружения
.env.development     # Переменные для development
.env.staging         # Переменные для staging
.env.production      # Переменные для production
.env-templates/      # Шаблоны файлов окружения
```

## Лучшие практики

1. **Всегда используйте скрипты** для переключения между контурами, а не редактируйте файлы вручную
2. **Не хардкодьте переменные окружения** в код, используйте `process.env.*`
3. **Проверяйте активное окружение** перед запуском критичных операций
4. **Храните специфичные для контура значения** в соответствующих файлах `.env.*`
5. **Используйте docker-compose down** перед переключением контуров, чтобы избежать конфликтов портов
