# Автоматизация проекта GPROD

## Централизованный healthcheck и DRY пайплайн (май 2025)

- Healthcheck для CI/CD пайплайна теперь реализован как централизованный bash-скрипт (`automation/scripts/healthcheck.sh`)
- Один и тот же скрипт используется во всех workflow-джобах (deploy, periodic), что устраняет дублирование логики (DRY)
- Скрипт поддерживает retry, проверку кода ответа, подробный вывод и диагностику
- В Telegram-алертах теперь приходит полный ответ healthcheck
- Это повышает надёжность пайплайна и упрощает сопровождение

## Общая информация

В директории `automation/` содержатся все инструменты автоматизации для разработки, тестирования и деплоя проекта GPROD. Эти скрипты обеспечивают управление окружениями, запуск контейнеров, тестирование и другие операции.

## Структура автоматизации

```
automation/
├── env/                        # Управление переменными окружения
│   ├── env-manager.sh            # Скрипт для настройки окружений
│   ├── env-switch-new.sh         # Новый скрипт переключения окружений
│   └── setup-env-files.sh        # Скрипт для настройки файлов окружения
├── k3s/                        # Инструменты для работы с K3S
│   ├── get_helm.sh               # Скрипт установки Helm
│   ├── collect_master.sh         # Скрипт для сбора информации о мастер-ноде
│   └── collect_master_optimized.sh # Оптимизированная версия
├── lib/                        # Библиотеки и утилиты
├── scripts/                    # Вспомогательные скрипты
│   ├── docker-smart-test.sh      # Запуск тестов в Docker
│   ├── docker-test-runner.sh     # Управление тестами в Docker
│   ├── run-env.sh                # Запуск окружения
│   └── run-tests.sh              # Запуск тестов
└── run.sh                      # Главный скрипт автоматизации
```

## Контуры окружения

Проект поддерживает три основных контура окружений:

1. **dev (development)** - для локальной разработки
   - Порт API: 3008
   - Порт БД: 5432

2. **stage (staging)** - для тестирования перед релизом
   - Порт API: 3003
   - Порт БД: 5433

3. **prod (production)** - для продакшн-окружения
   - Порт API: 3007
   - Порт БД: 5434

4. **reference** - минимальная конфигурация для быстрой разработки
   - Порт API: 3000
   - Порт БД: 5432

## Основные команды автоматизации

### Через npm/pnpm скрипты

```bash
# Запуск автоматизации с интерактивным выбором
pnpm auto:interactive

# Настройка окружения
pnpm auto:env:dev      # Настройка development окружения
pnpm auto:env:stage    # Настройка staging окружения
pnpm auto:env:prod     # Настройка production окружения

# Запуск окружения (настройка + запуск Docker)
pnpm auto:run:dev      # Запуск development контура
pnpm auto:run:stage    # Запуск staging контура
pnpm auto:run:prod     # Запуск production контура

# Остановка окружения
pnpm auto:stop:dev     # Остановка development контура
pnpm auto:stop:stage   # Остановка staging контура
pnpm auto:stop:prod    # Остановка production контура

# Просмотр логов
pnpm auto:logs:dev     # Просмотр логов development контура
pnpm auto:logs:stage   # Просмотр логов staging контура
pnpm auto:logs:prod    # Просмотр логов production контура

# Запуск тестов
pnpm auto:test         # Запуск всех тестов
```

### Напрямую через скрипты

```bash
# Главный скрипт автоматизации
./automation/run.sh [команда] [контур]

# Скрипт управления окружением
./automation/env/env-manager.sh [контур] [--silent] [--docker|--local]
```

## Работа с K3S

Скрипты в директории `automation/k3s/` обеспечивают интеграцию с кластером Kubernetes:

- `get_helm.sh` - скрипт для установки Helm (менеджер пакетов Kubernetes)
- `collect_master.sh` - сбор информации о мастер-ноде K3S кластера
- `collect_master_optimized.sh` - оптимизированная версия скрипта сбора информации

Эти скрипты используются при настройке CI/CD и работе с кластером.

## Environment Automation (env)

- Управление переменными окружения централизовано через скрипты в `automation/env/`.
- Для любого окружения .env генерируется автоматически, используется симлинк `.env -> .env.<env>`.
- Всегда используйте скрипты для переключения окружений, не редактируйте .env вручную.
- Подробное руководство: [environment-management.md](environment-management.md)
