# Система доставки окружений

## Обзор

Система доставки окружений — это набор скриптов в директории `automation/env`, которые облегчают переключение между различными контурами окружения и автоматизируют настройку переменных окружения.

Основные компоненты:
- Скрипты для создания шаблонов `.env` файлов
- Скрипты для переключения между контурами окружения
- Интеграция с Docker для запуска сервисов в нужном окружении

## Структура скриптов

```
automation/env/
├── env-manager.sh       # Основной скрипт управления окружениями
├── env-switch-new.sh    # Скрипт переключения между окружениями
└── setup-env-files.sh   # Скрипт инициализации файлов окружения
```

## Основные команды

### Настройка окружений

```bash
# Инициализация всех файлов окружения из шаблонов
pnpm run env:setup

# Переключение между контурами
pnpm run env:switch dev     # Переключение на development 
pnpm run env:switch stage   # Переключение на staging
pnpm run env:switch prod    # Переключение на production
pnpm run env:switch test    # Переключение на test
```

### Docker-интеграция

```bash
# Запуск с определенным окружением
pnpm run docker:dev     # Запуск dev контейнеров
pnpm run docker:stage   # Запуск stage контейнеров
pnpm run docker:prod    # Запуск production контейнеров
```

## Детали скрипта env-manager.sh

Основной скрипт `env-manager.sh` отвечает за переключение между контурами и может работать как в интерактивном, так и в тихом режиме.

### Использование

```bash
./automation/env/env-manager.sh <dev|stage|prod|test> [--silent] [--docker|--local]
```

### Параметры

- `dev`, `stage`, `prod`, `test` - контур окружения для активации
- `--silent` - тихий режим без запросов пользователю
- `--docker` - подготовка окружения для запуска Docker
- `--local` - подготовка окружения для локального запуска

### Примеры использования

```bash
# Интерактивное переключение на development
./automation/env/env-manager.sh dev

# Тихое переключение на production
./automation/env/env-manager.sh prod --silent

# Подготовка staging окружения для Docker
./automation/env/env-manager.sh stage --docker
```

## Процесс работы скрипта env-manager.sh

1. **Определение параметров**:
   - Парсинг аргументов командной строки
   - Установка режима работы (интерактивный/тихий)
   - Установка целевого окружения

2. **Проверка файлов**:
   - Проверка наличия необходимых шаблонов
   - Если файлы не найдены, предложение создать их

3. **Копирование файла окружения**:
   - Создание .env файла из соответствующего шаблона
   - Применение дополнительных настроек в зависимости от режима (Docker/Local)

4. **Настройка Docker** (опционально):
   - Если выбран режим Docker, подготовка docker-compose файлов
   - Установка переменных для Docker-контейнеров

5. **Завершение**:
   - Вывод информации о завершенной операции
   - Рекомендации по следующим шагам

## Лучшие практики

1. **Используйте скрипты** вместо ручного копирования файлов
2. **Держите в репозитории** только шаблоны, а не реальные .env файлы
3. **Проверяйте контур** перед выполнением важных операций
4. **Автоматизируйте CI/CD** с помощью этих скриптов

## Интеграция с CI/CD

Скрипты доставки окружений могут быть интегрированы в CI/CD пайплайны:

```yaml
# Пример для GitHub Actions
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '16'
      - run: npm install -g pnpm
      - run: pnpm install
      - name: Setup environment
        run: |
          pnpm run env:setup
          pnpm run env:switch prod --silent
      - name: Deploy
        run: pnpm run deploy
```

## Расширение системы доставки

Для добавления нового контура окружения:

1. Создайте шаблон `.env.<new_environment>.template` в `.env-templates/`
2. Добавьте новый case в `env-manager.sh`
3. Обновите npm-скрипты в `package.json`
4. Обновите документацию
