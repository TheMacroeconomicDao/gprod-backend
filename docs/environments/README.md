# Окружения в GPROD

## Содержание

- [Контуры окружения](#контуры-окружения)
- [Система управления переменными окружения](#система-управления-переменными-окружения)
- [Шаблоны .env файлов](#шаблоны-env-файлов)
- [Скрипты для работы с окружениями](#скрипты-для-работы-с-окружениями)
- [Класс EnvHelper](#класс-envhelper)

## Контуры окружения

Проект поддерживает четыре основных контура окружения:

1. **Development** (`NODE_ENV=development`) - для локальной разработки
   - Порт по умолчанию: 3008
   - Оптимизирован для быстрой разработки
   - Подробные логи, автоперезагрузка

2. **Staging** (`NODE_ENV=staging`) - для тестирования перед продакшеном
   - Порт по умолчанию: 3003
   - Включены метрики и мониторинг
   - Имитирует продакшен-окружение для тестирования

3. **Production** (`NODE_ENV=production`) - боевое окружение
   - Порт по умолчанию: 3007
   - Оптимизировано для производительности
   - Строгие настройки безопасности

4. **Test** (`NODE_ENV=test`) - специально для запуска тестов
   - Порт по умолчанию: 3009
   - Конфигурация для запуска unit и e2e тестов

## Система управления переменными окружения

### Файлы окружения

Для каждого контура используется отдельный файл переменных окружения:

- `.env.development` - переменные для разработки
- `.env.staging` - переменные для staging-среды
- `.env.production` - переменные для продакшена
- `.env.test` - специальные переменные для тестов

Активный контур определяется симлинком `.env`, который указывает на соответствующий файл окружения.

### Шаблоны .env файлов

Шаблоны файлов окружения находятся в директории `.env-templates/`. Они содержат стандартные значения переменных для каждого контура без секретов.

```
.env-templates/
├── .env.development  # Шаблон для development
├── .env.staging      # Шаблон для staging
├── .env.production   # Шаблон для production
└── .env.test         # Шаблон для тестов
```

## Скрипты для работы с окружениями

### Базовые скрипты в package.json

```bash
# Установка начальных шаблонов .env файлов
pnpm run env:setup

# Выбор контура через новую систему
pnpm run env:dev    # Переключение на development
pnpm run env:stage  # Переключение на staging
pnpm run env:prod   # Переключение на production

# Более детальное управление через env-switch-new
pnpm run env:switch:new      # Интерактивный выбор контура
pnpm run env:dev:new [опции] # Development с доп. опциями
pnpm run env:stage:new       # Staging с интерактивным выбором
pnpm run env:prod:new        # Production с интерактивным выбором
```

### Автоматизированное управление окружениями

```bash
# Через систему автоматизации
pnpm run auto:env:dev    # Настройка development
pnpm run auto:env:stage  # Настройка staging
pnpm run auto:env:prod   # Настройка production
```

## Класс EnvHelper

Для программного доступа к переменным окружения используется класс `EnvHelper`, который предоставляет:

- **Типизированный доступ** - методы для получения строк, чисел, булевых значений и массивов
- **Fallback значения** - возможность указать значение по умолчанию
- **Валидацию** - проверку наличия обязательных переменных
- **Определение контекста** - методы для определения запуска в Docker или локально

### Основные методы

```typescript
// Получение строкового значения
EnvHelper.get('API_KEY', 'default_value');

// Получение числового значения
EnvHelper.int('PORT', 3000);

// Получение логического значения
EnvHelper.bool('DEBUG_MODE', false);

// Получение массива строк
EnvHelper.array('ALLOWED_ORIGINS', ['http://localhost']);

// Проверка текущего окружения
if (EnvHelper.isDevelopment) {
  // Код для development
}

// Проверка запуска в Docker
if (EnvHelper.isDocker) {
  // Код для Docker-окружения
}
```

## Дополнительные документы

- [Подробное описание EnvHelper](env-helper.md) - все методы и примеры использования
- [Переменные окружения](environment-variables.md) - список всех поддерживаемых переменных
- [Адаптация для разных сред](environment-adaptation.md) - настройка для различных инфраструктур 