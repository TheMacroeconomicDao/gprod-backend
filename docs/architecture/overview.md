# Анализ и обзор архитектуры GPROD

## 1. Общая информация

**Тип проекта**: RESTful API бэкенд приложение  
**Основные технологии**:
- NestJS (фреймворк)
- TypeScript
- Prisma ORM
- PostgreSQL
- Docker
- pnpm (пакетный менеджер)

**Структура окружений**:
- Development (dev): для локальной разработки
- Staging (stage): для тестирования перед релизом
- Production (prod): для боевого окружения

## 2. Архитектура приложения

### Модульная структура (NestJS)

Проект разделен на логические модули:
- **AppModule** - корневой модуль приложения
- **AuthModule** - аутентификация и авторизация
- **UsersModule** - управление пользователями
- **ProjectsModule** - управление проектами
- **HealthModule** - проверка работоспособности API

### Общие компоненты (src/common)

- **Гварды (Guards)** - контроль доступа и авторизация (JWT, Roles)
- **Интерсепторы (Interceptors)** - дополнительная обработка данных
- **Фильтры (Filters)** - обработка исключений и ошибок
- **Декораторы (Decorators)** - дополнительная информация для методов и классов
- **DTO** - типы данных для запросов и ответов
- **Сервисы** - логика бизнес-процессов

### Слои приложения

1. **Controller** - входные точки API (маршрутизация)
2. **Service** - бизнес-логика и обработка данных
3. **Repository** - взаимодействие с базой данных (через Prisma)
4. **DTO** - структуры данных для запросов и ответов

## 3. База данных и ORM

- **СУБД**: PostgreSQL
- **ORM**: Prisma
- **Модель**: Определена в `prisma/schema.prisma`
- **Миграции**: Автоматические через Prisma Migrate

**Основные сущности**:
- User - пользователи
- Project - проекты
- Task - задачи
- Role - роли пользователей
- Permission - разрешения
- Token - токены доступа

## 4. Аутентификация и авторизация

- **Метод**: JWT (JSON Web Tokens)
- **Реализация**: NestJS Passport + Гварды (Guards)
- **Типы доступа**:
  - Публичные маршруты (без аутентификации)
  - Защищенные маршруты (требуется JWT)
  - Маршруты с RBAC (требуется JWT + определенная роль)

**Процесс аутентификации**:
1. Пользователь отправляет учетные данные (логин/пароль)
2. Система проверяет данные и создает JWT + refresh token
3. Клиент использует JWT для доступа к API
4. При истечении JWT используется refresh token для получения нового JWT

## 5. Безопасность

- **Хэширование паролей**: bcrypt
- **CORS**: настраиваемый по окружениям
- **Rate limiting**: встроенный ThrottlerModule
- **Валидация данных**: class-validator + DTO
- **Защита от инъекций**: через Prisma (параметризованные запросы)
- **Защита от XSS**: встроенная санация входных данных

## 6. Тестирование

- **Unit-тесты**: Jest + ts-jest
- **E2E-тесты**: Supertest + Jest
- **Тестовая БД**: отдельная БД для тестов

**Структура тестов**:
- Unit-тесты рядом с тестируемыми файлами (*.spec.ts)
- E2E-тесты в директории test/

## 7. Производительность и масштабирование

- **Кэширование**: NestJS Cache Manager + Redis (опционально)
- **Логгирование**: Winston Logger (настраиваемые уровни по окружениям)
- **Сжатие**: через compression middleware
- **Балансировка нагрузки**: через Docker Compose/Nginx

## 8. API и документация

- **API**: RESTful + JSON
- **Версионирование**: через URL (api/v1, api/v2)
- **Документация**:
  - JSDoc для функций и методов
  - README для общей документации
  - API документация через Swagger

- **Swagger UI** - автоматически генерируемая документация
  - v1: /api/v1/docs
  - v2: /api/v2/docs (подготовлена для будущей версии API)

## 9. Миграции базы данных

Для управления схемой БД используется Prisma Migrate:

```bash
# Создание миграции
pnpm prisma migrate dev --name migration_name

# Применение миграций (для production)
pnpm prisma migrate deploy

# Сброс БД (для разработки)
pnpm prisma migrate reset
```

## 10. Docker и деплой

- **Docker Compose** для локальной разработки
- **Dockerfile** для сборки образа
- **CI/CD**: подготовлены конфигурации для автоматической сборки

**Конфигурации Docker-Compose**:
- `docker-compose.reference.yml` - минимальная конфигурация (DB + API)
- `docker-compose.yml` - полная конфигурация для разработки
- `docker-compose.prod.yml` - конфигурация для продакшена

## 11. Конвенции кода

- Strict TypeScript
- ESLint для проверки кода
- Prettier для форматирования
- Husky для pre-commit хуков
- Conventional Commits для структурирования коммитов

## 12. Управление зависимостями

- PNPM для управления пакетами
- pnpm-lock.yaml для фиксации версий
- Обновление зависимостей через renovate (автоматические PR)
