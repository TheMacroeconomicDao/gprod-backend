# Разделенная инфраструктура GPROD

## Концепция разделенной инфраструктуры

Начиная с версии 2.0, проект GPROD использует разделенную архитектуру с двумя основными репозиториями:

- **[gprod-backend](https://github.com/TheMacroeconomicDao/gprod-backend)** - код приложения, API, бизнес-логика
- **[gybernaty-infra](https://github.com/TheMacroeconomicDao/gybernaty-infra)** - инфраструктурные конфигурации

### Преимущества разделения

- ✅ **Чистота кодовой базы** - код приложения не смешивается с инфраструктурным кодом
- ✅ **Независимое развитие** - инфраструктура может развиваться отдельно от приложения
- ✅ **Соответствие принципам DevOps** - разделение ответственности
- ✅ **Экспертиза команд** - разные команды могут работать над кодом и инфраструктурой

## Способы запуска

### 1. Минимальный запуск для разработки (только Backend)

Для локальной разработки без сложной инфраструктуры можно использовать минимальную конфигурацию из основного репозитория:

```bash
# Клонирование основного репозитория
git clone https://github.com/TheMacroeconomicDao/gprod-backend.git
cd gprod-backend

# Установка зависимостей и настройка окружения
pnpm install
pnpm run env:setup
pnpm run env:switch dev

# Запуск минимальной конфигурации (только DB + API)
docker-compose -f docker-compose.reference.yml up -d
# или
pnpm run docker:reference
```

Эта конфигурация запускает:
- PostgreSQL на порту 5432
- Backend API на порту 3000

### 2. Полный запуск с полной инфраструктурой (рекомендуется для тестирования)

Для полноценного запуска со всей инфраструктурой:

```bash
# 1. Клонируем оба репозитория
git clone https://github.com/TheMacroeconomicDao/gprod-backend.git
git clone https://github.com/TheMacroeconomicDao/gybernaty-infra.git

# 2. Настраиваем основной проект
cd gprod-backend
pnpm install
pnpm run env:setup
pnpm run env:switch dev  # или stage/prod в зависимости от контура

# 3. Переходим в репозиторий инфраструктуры
cd ../gybernaty-infra

# 4. Копируем файл переменных окружения и настраиваем его
cp .env.example .env
# Отредактируйте .env при необходимости

# 5. Запускаем нужный контур
# Для разработки:
docker-compose -f docker/docker-compose.yml -f docker/dev/docker-compose.dev.yml up -d

# ИЛИ для staging:
# docker-compose -f docker/docker-compose.yml -f docker/stage/docker-compose.stage.yml up -d

# ИЛИ для production:
# docker-compose -f docker/docker-compose.yml -f docker/prod/docker-compose.prod.yml up -d
```

### 3. Гибридный подход (Backend + выборочная инфраструктура)

Если вам нужны определенные части инфраструктуры (например, только мониторинг):

```bash
# 1. Настройте базовый Backend как в варианте 1
cd gprod-backend
docker-compose -f docker-compose.reference.yml up -d

# 2. Запустите нужные компоненты из инфраструктурного репозитория
cd ../gybernaty-infra

# Например, только мониторинг
docker-compose -f docker/monitoring.yml up -d

# Или только Nginx
docker-compose -f docker/nginx.yml up -d
```

## Содержимое инфраструктурного репозитория

Репозиторий `gybernaty-infra` содержит следующие основные компоненты:

- **Nginx** - прокси-сервер и балансировщик нагрузки
- **PostgreSQL** - основная база данных
- **Redis** - кэширование и очереди задач
- **Prometheus** - сбор метрик
- **Grafana** - визуализация метрик и мониторинг
- **Docker Compose** файлы для разных окружений:
  - Development (dev)
  - Staging (stage)
  - Production (prod)

## Переменные окружения

При работе с разделенной инфраструктурой важно синхронизировать переменные окружения между репозиториями:

- `gprod-backend/.env` - конфигурация для API и Backend
- `gybernaty-infra/.env` - конфигурация для инфраструктуры

Обязательные переменные для синхронизации:
- `POSTGRES_PASSWORD` - пароль для базы данных
- `JWT_SECRET` - секретный ключ для JWT токенов
- `PORT` - порт для API (должен совпадать с проксированием в Nginx)

## Сетевое взаимодействие

В разделенной инфраструктуре каждая Docker-сеть имеет свое имя:

- **Development**: `gp-network`
- **Staging**: `gp-network-stage`
- **Production**: `gp-network-prod`

В разных контурах сервисы доступны по разным портам:

| Сервис | Development | Staging | Production |
|--------|-------------|---------|------------|
| API    | 3000        | 3100    | 3200       |
| DB     | 5432        | 5433    | 5434       |
| Adminer| 8080        | 8081    | 8082       |
| Redis  | 6379        | 6380    | 6381       |

## Управление данными

Для разделения пользовательских данных между контурами используются отдельные тома:

- **Development**: `pgdata_dev`, `app_data_dev`
- **Staging**: `pgdata_stage`, `app_data_stage`
- **Production**: `pgdata_prod`, `app_data_prod`

## Устранение неполадок

### API не видит базу данных

Если API контейнер не может подключиться к базе данных:

1. Проверьте, что `DATABASE_URL` в `.env` правильно указывает на хост БД
2. При использовании полной инфраструктуры, имя сервиса БД должно быть `db`
3. При использовании минимального запуска, также `db`

### Проблемы с переменными окружения

Если возникают проблемы с переменными окружения:

1. Убедитесь, что `.env` файл скопирован в оба репозитория
2. Проверьте отсутствие опечаток в именах переменных
3. Используйте `EnvHelper.get('VARIABLE_NAME', undefined, true)` для проверки обязательных переменных при старте приложения

### Миграции базы данных не применяются

Если миграции не применяются:

1. Убедитесь, что в переменной `DATABASE_URL` правильно указан хост БД
2. Проверьте, что у пользователя БД есть права на создание таблиц
3. При работе с разделенной инфраструктурой, запускайте миграции внутри контейнера API

## Рекомендации и лучшие практики

1. **Одинаковые переменные окружения** - поддерживайте синхронизацию переменных между репозиториями
2. **Используйте Docker Networks** - для изоляции сервисов в каждом контуре
3. **Тестируйте изменения на staging** - перед отправкой в production
4. **Документируйте изменения инфраструктуры** - в README или документации
5. **Храните конфигурации как код** - используйте системы управления конфигурациями
6. **Мониторьте состояние систем** - через Prometheus/Grafana
7. **Создавайте резервные копии данных** - особенно перед крупными обновлениями
