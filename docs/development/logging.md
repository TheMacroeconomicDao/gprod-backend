# Система логирования GPROD Backend

## Обзор

В проекте GPROD внедрена продвинутая система логирования на основе Winston, обеспечивающая надежное отслеживание всех действий приложения в разных контурах окружения.

## Возможности системы логирования

- ✅ **Структурированные JSON-логи** в production-режиме
- ✅ **Читаемые цветные логи** в dev-режиме
- ✅ **Ротация файлов логов** для управления объемом данных
- ✅ **Контекстуальное логирование** с указанием модуля/компонента
- ✅ **Трассировка запросов** через уникальные requestId
- ✅ **Отдельный файл для ошибок** для быстрого анализа инцидентов
- ✅ **Метрики производительности** для диагностики узких мест

## Настройка через переменные окружения

```env
# Настройки логирования
LOG_LEVEL=debug          # Уровень детализации (debug, info, warn, error)
LOG_FILE_PATH=./logs/app.log  # Путь к основному файлу логов
```

## Использование в коде

### Базовое использование

```typescript
// Импорт
import { WinstonLogger } from '../common/logger/winston.logger';

// Создание логгера с контекстом
private readonly logger = new WinstonLogger('MyService');

// Базовое логирование
this.logger.log('Сообщение');
this.logger.debug('Отладочная информация');
this.logger.warn('Предупреждение');
this.logger.error('Ошибка', error.stack);
```

### Продвинутое использование

```typescript
// Логирование с контекстом
this.logger.log('Сообщение', 'Контекст');

// Логирование с метаданными
this.logger.log('Сообщение', 'Контекст', { userId: 123, action: 'create' });

// Логирование с метриками производительности
const startTime = process.hrtime();
// ... код операции ...
this.logger.logWithPerformance('Операция завершена', startTime);
```

## Структура логов

### Development режим (форматированный вывод)

```
2025-05-03 17:48:25 [info] [MyService] Пользователь создан
```

### Production режим (JSON)

```json
{
  "timestamp": "2025-05-03T17:48:25.123Z",
  "level": "info",
  "message": "Пользователь создан",
  "context": "MyService",
  "service": "GPROD API",
  "environment": "production",
  "userId": 123
}
```

## Файлы логов

Логи сохраняются в директории `logs/` со следующей структурой:
- `app-YYYY-MM-DD.log` - все логи за указанную дату
- `error-YYYY-MM-DD.log` - только ошибки за указанную дату

## Логирование HTTP-запросов

Все HTTP-запросы автоматически логируются с помощью `RequestLoggerMiddleware`, который:
- Генерирует уникальный requestId для каждого запроса
- Логирует начало запроса с информацией о методе, URL и заголовках
- Логирует завершение запроса с информацией о статусе и времени выполнения
- Автоматически устанавливает уровень лога в зависимости от HTTP-статуса (200 - debug, 400 - warn, 500 - error)

## Интеграция с мониторингом

Система логирования интегрирована с Prometheus и Grafana для визуального отслеживания:
- Количества запросов
- Времени ответа
- Частоты ошибок
- Распределения HTTP-статусов

## Лучшие практики

1. **Контекст**: Всегда указывайте контекст (модуль или сервис) для облегчения поиска и фильтрации логов.
   ```typescript
   const logger = new WinstonLogger('AuthService');
   ```

2. **Уровни логирования**: Используйте соответствующие уровни логирования:
   - `debug` - для детальной отладочной информации (только в development)
   - `log` или `info` - для информационных сообщений
   - `warn` - для потенциальных проблем
   - `error` - для ошибок, требующих внимания

3. **Структурированные метаданные**: Передавайте информацию в структурированном виде:
   ```typescript
   logger.log(
     'Пользователь создан', 
     'UserService', 
     { userId: user.id, email: user.email, roles: user.roles }
   );
   ```

4. **Избегайте чувствительных данных**: Никогда не логируйте:
   - Пароли (даже хешированные)
   - Токены доступа
   - Личные данные пользователей
   - Ключи API

5. **Логирование производительности**: Для ресурсоемких операций используйте метрики производительности:
   ```typescript
   const startTime = process.hrtime();
   // Выполнение операции
   logger.logWithPerformance('Сложная операция завершена', startTime);
   ```
