# Управление окружениями в GPROD Backend

## Обзор системы окружений

GPROD Backend использует гибкую систему управления переменными окружения, которая поддерживает четыре основных контура:

| Контур | Описание | Файл конфигурации | Порт API |
|--------|----------|-------------------|----------|
| **Development** (`dev`) | Для локальной разработки | `.env.development` | 3000 |
| **Staging** (`stage`) | Для тестирования перед продакшеном | `.env.staging` | 3003 |
| **Production** (`prod`) | Для промышленной эксплуатации | `.env.production` | 3007 |
| **Test** (`test`) | Специально для запуска тестов | `.env.test` | - |

## Файлы окружения

### Структура файлов

Для каждого контура используется отдельный файл переменных:

- `.env.development` - переменные для разработки
- `.env.staging` - переменные для staging-среды
- `.env.production` - переменные для продакшена
- `.env.test` - специальные переменные для тестов

Шаблоны этих файлов находятся в директории `.env-templates/`.

### Создание и настройка файлов окружения

```bash
# Создание шаблонов .env файлов
pnpm run env:setup

# Интерактивный выбор окружения
pnpm run env:switch:new

# Активация конкретного окружения
pnpm run env:dev:new        # development
pnpm run env:stage:new      # staging
pnpm run env:prod:new       # production
```

## Система EnvHelper

`EnvHelper` - это специальный класс, который предоставляет удобный и типобезопасный доступ к переменным окружения.

### Основные возможности

- **Автоопределение контура** - определяет текущий контур на основе `NODE_ENV`
- **Типизированный доступ** - методы для получения строк, чисел, булевых значений и массивов
- **Fallback значения** - можно указать значение по умолчанию
- **Валидация** - проверка наличия обязательных переменных
- **Кэширование** - для оптимизации производительности
- **Определение контекста выполнения** - методы для определения запуска в Docker или локально

### Основные методы

```typescript
// Получение строкового значения (с опциональным fallback и валидацией)
EnvHelper.get('KEY', 'default_value', required);

// Получение числового значения
EnvHelper.int('KEY', 123, required);

// Получение логического значения
EnvHelper.bool('KEY', false, required);

// Получение массива строк (разделенных запятыми)
EnvHelper.array('KEY', ['default'], required);

// Специализированные методы для часто используемых переменных
EnvHelper.getDatabaseUrl();
EnvHelper.getJwtSecret();
EnvHelper.getJwtExpires();
```

### Вспомогательные методы

```typescript
// Проверка окружения
EnvHelper.isDevelopment
EnvHelper.isStaging
EnvHelper.isProduction
EnvHelper.isTest

// Определение запуска в Docker
EnvHelper.isDocker

// Очистка кэша
EnvHelper.clearCache()
```

## Рекомендации по использованию

1. ✅ Всегда используйте `EnvHelper` для доступа к переменным окружения вместо прямого обращения к `process.env`
2. ✅ Определяйте обязательные переменные через параметр `required = true`
3. ✅ Не храните чувствительные данные в репозитории - используйте переменные окружения
4. ✅ При добавлении новых переменных обновляйте шаблоны в `.env-templates/`
5. ✅ Синхронизируйте переменные окружения между основным и инфраструктурным репозиториями

## Критические переменные окружения

| Переменная | Описание | Пример значения |
|------------|----------|-----------------|
| `NODE_ENV` | Текущий контур окружения | `development`, `staging`, `production`, `test` |
| `DATABASE_URL` | URL для подключения к PostgreSQL | `postgresql://postgres:password@localhost:5432/gprod_db` |
| `PORT` | Порт для API сервера | `3000` |
| `JWT_SECRET` | Секретный ключ для JWT | `your-secret-key-here` |
| `JWT_EXPIRES` | Время жизни JWT токена | `15m` |
| `REFRESH_TOKEN_EXPIRES` | Время жизни Refresh токена | `7d` |
| `LOG_LEVEL` | Уровень детализации логирования | `debug`, `info`, `warn`, `error` |
