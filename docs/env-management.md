# Управление окружениями и тестирование

## Система управления переменными окружения

Проект использует усовершенствованную систему управления переменными окружения, основанную на классе `EnvHelper`. Эта система позволяет гибко настраивать приложение для различных сред выполнения.

### Контуры окружения

Поддерживаются четыре основных контура:

1. **Development** (`NODE_ENV=development`) - для локальной разработки
2. **Staging** (`NODE_ENV=staging`) - для тестирования перед продакшеном
3. **Production** (`NODE_ENV=production`) - боевое окружение
4. **Test** (`NODE_ENV=test`) - специально для запуска тестов

### Файлы окружения

Для каждого контура используется отдельный файл переменных окружения:

- `.env.development` - переменные для разработки
- `.env.staging` - переменные для staging-среды
- `.env.production` - переменные для продакшена
- `.env.test` - специальные переменные для тестов

Шаблоны этих файлов находятся в директории `.env-templates/`.

### Особенности EnvHelper

`EnvHelper` предоставляет следующие возможности:

- **Автоопределение контура** - определяет текущий контур на основе `NODE_ENV`
- **Типизированный доступ** - методы для получения строк, чисел, булевых значений и массивов
- **Fallback значения** - можно указать значение по умолчанию
- **Валидация** - проверка наличия обязательных переменных
- **Кэширование** - для оптимизации производительности
- **Определение контекста выполнения** - методы для определения запуска в Docker или локально

### Основные методы

```typescript
// Получение строкового значения (с опциональным fallback и валидацией)
EnvHelper.get('KEY', 'default_value', required);

// Получение числового значения
EnvHelper.int('KEY', 123, required);

// Получение логического значения
EnvHelper.bool('KEY', false, required);

// Получение массива строк (разделенных запятыми)
EnvHelper.array('KEY', ['default'], required);

// Специализированные методы для часто используемых переменных
EnvHelper.getDatabaseUrl();
EnvHelper.getJwtSecret();
EnvHelper.getJwtExpires();
```

### Вспомогательные методы

```typescript
// Проверка окружения
EnvHelper.isDevelopment
EnvHelper.isStaging
EnvHelper.isProduction
EnvHelper.isTest

// Определение запуска в Docker
EnvHelper.isDocker

// Очистка кэша
EnvHelper.clearCache()
```

## Система логирования

### Общие сведения

В проекте внедрена продвинутая система логирования на основе Winston, которая поддерживает:

- Структурированные JSON-логи в production-режиме
- Читаемые цветные логи в dev-режиме
- Автоматическую ротацию файлов логов
- Контекстуальное логирование с указанием модуля/компонента
- Трассировку запросов через уникальные requestId
- Отдельный файл для ошибок
- Метрики производительности

### Настройка через переменные окружения

```
# Настройки логирования
LOG_LEVEL=debug          # Уровень детализации (debug, info, warn, error)
LOG_FILE_PATH=./logs/app.log  # Путь к основному файлу логов
```

### Использование в коде

```typescript
// Импорт
import { WinstonLogger } from '../common/logger/winston.logger';

// Создание логгера с контекстом
private readonly logger = new WinstonLogger('MyService');

// Базовое логирование
this.logger.log('Сообщение');
this.logger.debug('Отладочная информация');
this.logger.warn('Предупреждение');
this.logger.error('Ошибка', error.stack);

// Логирование с контекстом
this.logger.log('Сообщение', 'Контекст');

// Логирование с метаданными
this.logger.log('Сообщение', 'Контекст', { userId: 123, action: 'create' });

// Логирование с метриками производительности
const startTime = process.hrtime();
// ... код операции ...
this.logger.logWithPerformance('Операция завершена', startTime);
```

### Структура логов

#### Development режим (форматированный вывод):
```
2024-05-03 17:48:25 [info] [MyService] Пользователь создан
```

#### Production режим (JSON):
```json
{
  "timestamp": "2024-05-03T17:48:25.123Z",
  "level": "info",
  "message": "Пользователь создан",
  "context": "MyService",
  "service": "GPROD API",
  "environment": "production",
  "userId": 123
}
```

### Файлы логов

Логи сохраняются в директории `logs/` со следующей структурой:
- `app-YYYY-MM-DD.log` - все логи за указанную дату
- `error-YYYY-MM-DD.log` - только ошибки за указанную дату

### Логирование HTTP-запросов

Все HTTP-запросы автоматически логируются с помощью `RequestLoggerMiddleware`, который:
- Генерирует уникальный requestId для каждого запроса
- Логирует начало запроса с информацией о методе, URL и заголовках
- Логирует завершение запроса с информацией о статусе и времени выполнения
- Автоматически устанавливает уровень лога в зависимости от HTTP-статуса (200 - debug, 400 - warn, 500 - error)

## Система тестирования

### Улучшенная система для запуска тестов

Для удобства запуска тестов в различных окружениях разработан скрипт `scripts/run-tests.sh`, который:

1. Автоматически определяет среду выполнения (Docker или локальная машина)
2. Настраивает переменные окружения соответствующим образом
3. Проверяет доступность базы данных и создает ее при необходимости
4. Применяет миграции перед запуском e2e тестов
5. Поддерживает различные ОС (Linux, macOS)

### Команды для запуска тестов

- `pnpm run test:smart` - запустить все тесты (unit + e2e)
- `pnpm run test:smart:unit` - запустить только unit тесты
- `pnpm run test:smart:e2e` - запустить только e2e тесты
- `pnpm run test:setup` - создать файлы переменных окружения для тестов

### Особенности тестирования

#### Unit тесты

Unit тесты не требуют подключения к базе данных, т.к. используют mock-объекты для имитации внешних зависимостей. Они проверяют логику отдельных компонентов (контроллеры, сервисы) в изоляции.

#### E2E тесты

E2E (end-to-end) тесты проверяют работу системы целиком, включая взаимодействие с базой данных. Они требуют:

1. Запущенного PostgreSQL сервера
2. Созданной тестовой базы данных
3. Применения миграций к тестовой базе данных

При запуске e2e тестов система:
- Автоматически определяет, запущена ли она в Docker или локально
- Адаптирует DATABASE_URL соответствующим образом
- Очищает базу данных перед каждым тестом для изоляции тестовых данных

## Настройка окружения

### Создание файлов окружения

Для создания шаблонов файлов окружения выполните:

```bash
pnpm run test:setup
```

Затем скопируйте файлы из `.env-templates/` в корень проекта и настройте их под свои нужды.

### Переключение между контурами

В проекте предусмотрены скрипты для переключения между контурами:

```bash
# Переключиться на dev окружение
pnpm run env:dev:new

# Переключиться на staging окружение
pnpm run env:stage:new

# Переключиться на production окружение
pnpm run env:prod:new
```

## Рекомендации по использованию

1. Всегда используйте `EnvHelper` для доступа к переменным окружения вместо прямого обращения к `process.env`
2. Определяйте обязательные переменные через параметр `required = true`
3. Для тестов всегда используйте `pnpm run test:smart` или его вариации
4. Не храните чувствительные данные в репозитории - используйте переменные окружения
5. При добавлении новых переменных обновляйте шаблоны в `.env-templates/` 